<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Avatar 50 NƒÉm Dalattourist</title>
    <style>
        :root { --primary: #006837; }
        body { font-family: -apple-system, system-ui, sans-serif; text-align: center; background: #f0f2f5; margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); margin: 0 0 15px 0; font-size: 20px; text-transform: uppercase; }
        
        /* Khu v·ª±c hi·ªÉn th·ªã ·∫£nh cƒÉn ch·ªânh */
        .work-area { position: relative; width: 100%; aspect-ratio: 1/1; background: #e9ecef; margin-bottom: 20px; border-radius: 12px; overflow: hidden; touch-action: none; border: 2px solid #ddd; }
        #userImage { position: absolute; top: 0; left: 0; transform-origin: top left; cursor: move; display: none; }
        #frameOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }

        /* N√∫t ch·ªçn ·∫£nh to, r√µ r√†ng */
        .upload-box { margin-bottom: 20px; }
        #fileInput { display: none; }
        .btn-select { background: #007bff; color: white; padding: 15px; border-radius: 10px; display: block; font-weight: bold; cursor: pointer; text-decoration: none; }

        /* Thanh ƒëi·ªÅu khi·ªÉn zoom */
        .controls { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 15px; display: none; border: 1px solid #dee2e6; }
        input[type="range"] { width: 100%; accent-color: var(--primary); margin-top: 10px; }

        .btn-render { background: var(--primary); color: white; padding: 15px; border: none; border-radius: 30px; cursor: pointer; font-weight: bold; font-size: 16px; display: none; width: 100%; }
        
        /* K·∫øt qu·∫£ cu·ªëi c√πng */
        #resultContainer { display: none; margin-top: 25px; padding: 10px; border: 3px solid var(--primary); border-radius: 15px; background: #fff; }
        #finalResult { width: 100%; border-radius: 8px; display: block; -webkit-touch-callout: default !important; }
        canvas { display: none; }
        .tip { font-size: 14px; color: #d9534f; font-weight: bold; margin-top: 10px; line-height: 1.5; }
    </style>
</head>
<body>

<div class="container">
    <h2>50 NƒÇM DALATTOURIST</h2>
    
    <div class="work-area" id="workArea">
        <img id="userImage" src="">
        <img id="frameOverlay" src="AVATA-02.png">
    </div>

    <div class="upload-box">
        <label for="fileInput" class="btn-select">üì∏ B·∫§M V√ÄO ƒê√ÇY ƒê·ªÇ CH·ªåN ·∫¢NH</label>
        <input type="file" id="fileInput" accept="image/*">
    </div>

    <div id="editTools">
        <div class="controls" id="zoomBox">
            <label style="font-size:13px; font-weight:bold;">PH√ìNG TO / THU NH·ªé</label>
            <input type="range" id="zoomSlider" min="0.1" max="3" step="0.01" value="1">
            <p style="font-size: 11px; color: #666; margin: 5px 0 0 0;">D√πng ng√≥n tay k√©o ·∫£nh ƒë·ªÉ di chuy·ªÉn v√†o gi·ªØa khung tr√≤n</p>
        </div>
        <button id="renderBtn" class="btn-render">HO√ÄN T·∫§T & XU·∫§T ·∫¢NH</button>
    </div>

    <div id="resultContainer">
        <img id="finalResult">
        <div class="tip">
            üëâ NH·∫§N GI·ªÆ V√ÄO ·∫¢NH TR√äN 2 GI√ÇY<br>
            CH·ªåN "TH√äM V√ÄO ·∫¢NH" (iPHONE)<br>
            HO·∫∂C "T·∫¢I H√åNH ·∫¢NH XU·ªêNG" (ANDROID)
        </div>
    </div>
</div>

<canvas id="exportCanvas" width="2000" height="2000"></canvas>

<script>
    const fileInput = document.getElementById('fileInput');
    const userImage = document.getElementById('userImage');
    const zoomSlider = document.getElementById('zoomSlider');
    const workArea = document.getElementById('workArea');
    const renderBtn = document.getElementById('renderBtn');
    const zoomBox = document.getElementById('zoomBox');
    const resultContainer = document.getElementById('resultContainer');
    const finalResult = document.getElementById('finalResult');
    const exportCanvas = document.getElementById('exportCanvas');

    let scale = 1, posX = 0, posY = 0, isDragging = false, startX, startY;

    // X·ª≠ l√Ω khi ch·ªçn file
    fileInput.onchange = (e) => {
        const file = e.target.files[0];
        if (!file) return;
        const reader = new FileReader();
        reader.onload = (event) => {
            userImage.src = event.target.result;
            userImage.style.display = 'block';
            zoomBox.style.display = 'block';
            renderBtn.style.display = 'block';
            resultContainer.style.display = 'none';
            // Reset v·ªã tr√≠ ·∫£nh m·ªõi
            scale = 1; posX = 0; posY = 0; zoomSlider.value = 1;
            updateTransform();
        };
        reader.readAsDataURL(file);
    };

    // H√†m l·∫•y t·ªça ƒë·ªô c·∫£m ·ª©ng/chu·ªôt
    const getPos = (e) => ({
        x: e.touches ? e.touches[0].clientX : e.clientX,
        y: e.touches ? e.touches[0].clientY : e.clientY
    });

    workArea.onmousedown = workArea.ontouchstart = (e) => {
        if (userImage.src === "") return;
        isDragging = true;
        const p = getPos(e);
        startX = p.x - posX; startY = p.y - posY;
        if(e.cancelable) e.preventDefault();
    };

    window.onmousemove = window.ontouchmove = (e) => {
        if (!isDragging) return;
        const p = getPos(e);
        posX = p.x - startX; posY = p.y - startY;
        updateTransform();
    };

    window.onmouseup = window.ontouchend = () => isDragging = false;
    zoomSlider.oninput = () => { scale = parseFloat(zoomSlider.value); updateTransform(); };

    function updateTransform() { 
        userImage.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`; 
    }

    // Xu·∫•t ·∫£nh ch·∫•t l∆∞·ª£ng cao
    renderBtn.onclick = () => {
        const ctx = exportCanvas.getContext('2d');
        const frameImg = new Image();
        frameImg.src = 'AVATA-02.png';
        frameImg.onload = () => {
            ctx.clearRect(0, 0, 2000, 2000);
            const ratio = 2000 / workArea.offsetWidth;
            ctx.save();
            ctx.translate(posX * ratio, posY * ratio);
            ctx.scale(scale * ratio, scale * ratio);
            ctx.drawImage(userImage, 0, 0);
            ctx.restore();
            ctx.drawImage(frameImg, 0, 0, 2000, 2000);
            
            finalResult.src = exportCanvas.toDataURL("image/png");
            resultContainer.style.display = 'block';
            setTimeout(() => {
                window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
            }, 300);
        };
    };
</script>
</body>
</html>
