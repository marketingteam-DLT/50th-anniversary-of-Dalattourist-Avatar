<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T√πy ch·ªânh Avatar 50 NƒÉm Dalattourist</title>
    <style>
        :root { --primary: #006837; }
        body { font-family: -apple-system, system-ui, sans-serif; text-align: center; background: #f0f2f5; margin: 0; padding: 15px; touch-action: manipulation; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        
        /* Khu v·ª±c t∆∞∆°ng t√°c */
        .work-area { position: relative; width: 100%; aspect-ratio: 1/1; background: #333; margin: 15px 0; border-radius: 12px; overflow: hidden; cursor: move; touch-action: none; }
        #userImage { position: absolute; top: 0; left: 0; transform-origin: top left; cursor: move; }
        #frameOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }

        .controls { background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .slider-group { margin: 10px 0; display: flex; align-items: center; gap: 10px; }
        input[type="range"] { flex: 1; accent-color: var(--primary); }

        .btn-group { display: flex; flex-direction: column; gap: 10px; }
        .btn { background: var(--primary); color: white; padding: 15px; border: none; border-radius: 30px; cursor: pointer; text-decoration: none; font-weight: bold; font-size: 16px; }
        .btn-secondary { background: #eee; color: #333; border: 1px solid #ccc; }
        
        canvas { display: none; }
        #finalResult { width: 100%; border-radius: 12px; display: none; margin-top: 15px; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color:var(--primary); margin:0 0 10px 0;">50 NƒÇM DALATTOURIST</h2>
    <p style="font-size: 14px; color: #666;">Ch·ªçn ·∫£nh -> K√©o & Ph√≥ng to ƒë·ªÉ cƒÉn ch·ªânh</p>

    <div class="work-area" id="workArea">
        <img id="userImage" src="" style="display:none;">
        <img id="frameOverlay" src="AVATA-02.png">
    </div>

    <div class="controls" id="controlPanel" style="display:none;">
        <div class="slider-group">
            <span>Thu nh·ªè</span>
            <input type="range" id="zoomSlider" min="0.1" max="3" step="0.01" value="1">
            <span>Ph√≥ng to</span>
        </div>
        <p style="font-size: 12px; color: #888; margin: 5px 0 0 0;">D√πng ng√≥n tay k√©o ·∫£nh ƒë·ªÉ di chuy·ªÉn</p>
    </div>

    <div class="btn-group">
        <label class="btn btn-secondary">
            CH·ªåN ·∫¢NH T·ª™ M√ÅY
            <input type="file" id="fileInput" accept="image/*" style="display:none;">
        </label>
        <button id="renderBtn" class="btn" style="display:none;">XU·∫§T ·∫¢NH AVATAR</button>
        <a id="downloadLink" class="btn" style="display:none;">T·∫¢I ·∫¢NH V·ªÄ</a>
    </div>

    <img id="finalResult" alt="K·∫øt qu·∫£">
    <p id="iphoneTip" style="display:none; color: #d9534f; font-size: 13px; margin-top: 10px;">
        üí° <b>M·∫πo cho iPhone:</b> Nh·∫•n gi·ªØ v√†o ·∫£nh tr√™n v√† ch·ªçn <b>"Th√™m v√†o ·∫¢nh"</b>.
    </p>
</div>

<canvas id="exportCanvas" width="2000" height="2000"></canvas>

<script>
    const fileInput = document.getElementById('fileInput');
    const userImage = document.getElementById('userImage');
    const zoomSlider = document.getElementById('zoomSlider');
    const workArea = document.getElementById('workArea');
    const renderBtn = document.getElementById('renderBtn');
    const finalResult = document.getElementById('finalResult');
    const downloadLink = document.getElementById('downloadLink');
    const exportCanvas = document.getElementById('exportCanvas');
    const controlPanel = document.getElementById('controlPanel');

    let scale = 1, posX = 0, posY = 0, isDragging = false, startX, startY;

    // 1. X·ª≠ l√Ω ch·ªçn ·∫£nh
    fileInput.addEventListener('change', (e) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            userImage.src = event.target.result;
            userImage.style.display = 'block';
            controlPanel.style.display = 'block';
            renderBtn.style.display = 'block';
            finalResult.style.display = 'none';
            downloadLink.style.display = 'none';
            
            // Reset v·ªã tr√≠
            scale = 1; posX = 0; posY = 0;
            zoomSlider.value = 1;
            updateTransform();
        };
        reader.readAsDataURL(e.target.files[0]);
    });

    // 2. X·ª≠ l√Ω Di chuy·ªÉn (Drag) - H·ªó tr·ª£ c·∫£ Chu·ªôt v√† C·∫£m ·ª©ng
    const startMove = (e) => {
        isDragging = true;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        startX = clientX - posX;
        startY = clientY - posY;
    };

    const move = (e) => {
        if (!isDragging) return;
        const clientX = e.touches ? e.touches[0].clientX : e.clientX;
        const clientY = e.touches ? e.touches[0].clientY : e.clientY;
        posX = clientX - startX;
        posY = clientY - startY;
        updateTransform();
    };

    const endMove = () => isDragging = false;

    workArea.addEventListener('mousedown', startMove);
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseup', endMove);
    workArea.addEventListener('touchstart', startMove);
    window.addEventListener('touchmove', move);
    window.addEventListener('touchend', endMove);

    // 3. X·ª≠ l√Ω Ph√≥ng to (Zoom)
    zoomSlider.addEventListener('input', () => {
        scale = parseFloat(zoomSlider.value);
        updateTransform();
    });

    function updateTransform() {
        userImage.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
    }

    // 4. Xu·∫•t ·∫£nh (Render)
    renderBtn.addEventListener('click', () => {
        const ctx = exportCanvas.getContext('2d');
        const frameImg = new Image();
        frameImg.src = 'AVATA-02.png';

        frameImg.onload = () => {
            ctx.clearRect(0, 0, 2000, 2000);
            
            // T√≠nh to√°n t·ªâ l·ªá gi·ªØa m√†n h√¨nh v√† canvas 2000px
            const ratio = 2000 / workArea.offsetWidth;
            
            ctx.save();
            ctx.translate(posX * ratio, posY * ratio);
            ctx.scale(scale * ratio, scale * ratio);
            ctx.drawImage(userImage, 0, 0);
            ctx.restore();

            ctx.drawImage(frameImg, 0, 0, 2000, 2000);

            const dataURL = exportCanvas.toDataURL("image/png");
            finalResult.src = dataURL;
            finalResult.style.display = 'block';
            downloadLink.href = dataURL;
            downloadLink.download = "Avatar_Dalattourist_Custom.png";
            downloadLink.style.display = 'block';
            document.getElementById('iphoneTip').style.display = 'block';
            
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        };
    });
</script>

</body>
</html>
