<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Avatar 50 NƒÉm Dalattourist</title>
    <style>
        :root { --primary: #006837; }
        body { font-family: -apple-system, system-ui, sans-serif; text-align: center; background: #f0f2f5; margin: 0; padding: 15px; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        h2 { color: var(--primary); margin: 0 0 10px 0; font-size: 22px; }
        
        /* Khu v·ª±c ch·ªânh s·ª≠a */
        .work-area { position: relative; width: 100%; aspect-ratio: 1/1; background: #eee; margin: 15px 0; border-radius: 12px; overflow: hidden; touch-action: none; border: 1px solid #ddd; }
        #userImage { position: absolute; top: 0; left: 0; transform-origin: top left; cursor: move; }
        #frameOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }

        .controls { background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 15px; border: 1px solid #eee; }
        input[type="range"] { width: 100%; accent-color: var(--primary); margin: 10px 0; }

        .btn { background: var(--primary); color: white; padding: 15px; border: none; border-radius: 30px; cursor: pointer; text-decoration: none; font-weight: bold; font-size: 16px; display: block; width: 100%; box-sizing: border-box; margin-bottom: 10px; }
        .btn-select { background: #f0f0f0; color: #333; border: 1px solid #ccc; }
        
        /* Khu v·ª±c k·∫øt qu·∫£ */
        #resultContainer { display: none; margin-top: 20px; padding: 10px; border: 2px dashed var(--primary); border-radius: 15px; }
        #finalResult { width: 100%; border-radius: 10px; display: block; -webkit-touch-callout: default !important; }
        canvas { display: none; }
        .tip { font-size: 14px; color: #d9534f; font-weight: bold; margin-top: 10px; }
    </style>
</head>
<body>

<div class="container">
    <h2>50 NƒÇM DALATTOURIST</h2>
    
    <div class="work-area" id="workArea">
        <img id="userImage" src="" style="display:none;">
        <img id="frameOverlay" src="AVATA-02.png">
    </div>

    <div id="editTools" style="display:none;">
        <div class="controls">
            <label style="font-size:13px; color:#666;">Ph√≥ng to / Thu nh·ªè</label>
            <input type="range" id="zoomSlider" min="0.1" max="3" step="0.01" value="1">
            <p style="font-size: 11px; color: #999; margin: 0;">D√πng tay k√©o ·∫£nh ƒë·ªÉ cƒÉn ch·ªânh v·ªã tr√≠</p>
        </div>
        <button id="renderBtn" class="btn">XU·∫§T ·∫¢NH AVATAR</button>
    </div>

    <label class="btn btn-select">
        CH·ªåN ·∫¢NH T·ª™ M√ÅY
        <input type="file" id="fileInput" accept="image/*" style="display:none;">
    </label>

    <div id="resultContainer">
        <img id="finalResult">
        <p class="tip">üëâ NH·∫§N GI·ªÆ V√ÄO ·∫¢NH TR√äN<br>CH·ªåN "L∆ØU V√ÄO ·∫¢NH"</p>
    </div>
</div>

<canvas id="exportCanvas" width="2000" height="2000"></canvas>

<script>
    const fileInput = document.getElementById('fileInput');
    const userImage = document.getElementById('userImage');
    const zoomSlider = document.getElementById('zoomSlider');
    const workArea = document.getElementById('workArea');
    const renderBtn = document.getElementById('renderBtn');
    const editTools = document.getElementById('editTools');
    const resultContainer = document.getElementById('resultContainer');
    const finalResult = document.getElementById('finalResult');
    const exportCanvas = document.getElementById('exportCanvas');

    let scale = 1, posX = 0, posY = 0, isDragging = false, startX, startY;

    fileInput.onchange = (e) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            userImage.src = event.target.result;
            userImage.style.display = 'block';
            editTools.style.display = 'block';
            resultContainer.style.display = 'none';
            scale = 1; posX = 0; posY = 0; zoomSlider.value = 1;
            updateTransform();
        };
        reader.readAsDataURL(e.target.files[0]);
    };

    const getPos = (e) => ({
        x: e.touches ? e.touches[0].clientX : e.clientX,
        y: e.touches ? e.touches[0].clientY : e.clientY
    });

    workArea.onmousedown = workArea.ontouchstart = (e) => {
        isDragging = true;
        const p = getPos(e);
        startX = p.x - posX; startY = p.y - posY;
    };

    window.onmousemove = window.ontouchmove = (e) => {
        if (!isDragging) return;
        const p = getPos(e);
        posX = p.x - startX; posY = p.y - startY;
        updateTransform();
    };

    window.onmouseup = window.ontouchend = () => isDragging = false;
    zoomSlider.oninput = () => { scale = parseFloat(zoomSlider.value); updateTransform(); };

    function updateTransform() { userImage.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`; }

    renderBtn.onclick = () => {
        const ctx = exportCanvas.getContext('2d');
        const frameImg = new Image();
        frameImg.src = 'AVATA-02.png';
        frameImg.onload = () => {
            ctx.clearRect(0, 0, 2000, 2000);
            const ratio = 2000 / workArea.offsetWidth;
            ctx.save();
            ctx.translate(posX * ratio, posY * ratio);
            ctx.scale(scale * ratio, scale * ratio);
            ctx.drawImage(userImage, 0, 0);
            ctx.restore();
            ctx.drawImage(frameImg, 0, 0, 2000, 2000);
            finalResult.src = exportCanvas.toDataURL("image/png");
            resultContainer.style.display = 'block';
            window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' });
        };
    };
</script>
</body>
</html>
