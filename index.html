<!DOCTYPE html>
<html lang="vi">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>T√πy ch·ªânh Avatar 50 NƒÉm Dalattourist</title>
    <style>
        :root { --primary: #006837; }
        body { font-family: -apple-system, system-ui, sans-serif; text-align: center; background: #f0f2f5; margin: 0; padding: 15px; touch-action: manipulation; }
        .container { max-width: 500px; margin: auto; background: white; padding: 20px; border-radius: 20px; box-shadow: 0 8px 30px rgba(0,0,0,0.1); }
        
        /* Khu v·ª±c cƒÉn ch·ªânh */
        .work-area { position: relative; width: 100%; aspect-ratio: 1/1; background: #333; margin: 15px 0; border-radius: 12px; overflow: hidden; touch-action: none; }
        #userImage { position: absolute; top: 0; left: 0; transform-origin: top left; }
        #frameOverlay { position: absolute; top: 0; left: 0; width: 100%; height: 100%; pointer-events: none; z-index: 5; }

        .controls { background: #f9f9f9; padding: 15px; border-radius: 12px; margin-bottom: 15px; }
        .slider-group { margin: 10px 0; display: flex; align-items: center; gap: 10px; }
        input[type="range"] { flex: 1; accent-color: var(--primary); }

        .btn-group { display: flex; flex-direction: column; gap: 10px; }
        .btn { background: var(--primary); color: white; padding: 15px; border: none; border-radius: 30px; cursor: pointer; text-decoration: none; font-weight: bold; font-size: 16px; -webkit-appearance: none; }
        .btn-secondary { background: #eee; color: #333; border: 1px solid #ccc; }
        
        /* Khu v·ª±c k·∫øt qu·∫£ t·ªëi ∆∞u cho iPhone */
        .result-container { position: relative; width: 100%; margin-top: 20px; display: none; }
        #finalResult { width: 100%; border-radius: 12px; display: block; box-shadow: 0 5px 15px rgba(0,0,0,0.2); }
        
        /* L·ªõp ph·ªß t√†ng h√¨nh ƒë·ªÉ iPhone ch·ªâ nh·∫≠n di·ªán l·ªánh L∆ØU ·∫¢NH */
        .save-overlay { 
            position: absolute; top: 0; left: 0; width: 100%; height: 100%; 
            z-index: 999; opacity: 0; -webkit-touch-callout: default; 
        }

        canvas { display: none; }
        .tip { color: #d9534f; font-size: 14px; margin-top: 15px; font-weight: bold; }
    </style>
</head>
<body>

<div class="container">
    <h2 style="color:var(--primary); margin-bottom:10px;">50 NƒÇM DALATTOURIST</h2>

    <div class="work-area" id="workArea">
        <img id="userImage" src="" style="display:none;">
        <img id="frameOverlay" src="AVATA-02.png">
    </div>

    <div class="controls" id="controlPanel" style="display:none;">
        <div class="slider-group">
            <input type="range" id="zoomSlider" min="0.1" max="3" step="0.01" value="1">
        </div>
        <p style="font-size: 12px; color: #888;">K√©o ·∫£nh ƒë·ªÉ di chuy·ªÉn, d√πng thanh tr∆∞·ª£t ƒë·ªÉ ph√≥ng to</p>
    </div>

    <div class="btn-group">
        <label class="btn btn-secondary">
            CH·ªåN ·∫¢NH T·ª™ M√ÅY
            <input type="file" id="fileInput" accept="image/*" style="display:none;">
        </label>
        <button id="renderBtn" class="btn" style="display:none;">XU·∫§T ·∫¢NH K·∫æT QU·∫¢</button>
    </div>

    <div class="result-container" id="resultContainer">
        <img id="finalResult" alt="Avatar">
        <div class="save-overlay"></div> 
        <p class="tip">üëâ NH·∫§N GI·ªÆ V√ÄO ·∫¢NH TR√äN<br>CH·ªåN "L∆ØU V√ÄO ·∫¢NH"</p>
    </div>
</div>

<canvas id="exportCanvas" width="2000" height="2000"></canvas>

<script>
    const fileInput = document.getElementById('fileInput');
    const userImage = document.getElementById('userImage');
    const zoomSlider = document.getElementById('zoomSlider');
    const workArea = document.getElementById('workArea');
    const renderBtn = document.getElementById('renderBtn');
    const finalResult = document.getElementById('finalResult');
    const resultContainer = document.getElementById('resultContainer');
    const exportCanvas = document.getElementById('exportCanvas');
    const controlPanel = document.getElementById('controlPanel');

    let scale = 1, posX = 0, posY = 0, isDragging = false, startX, startY;

    fileInput.addEventListener('change', (e) => {
        const reader = new FileReader();
        reader.onload = (event) => {
            userImage.src = event.target.result;
            userImage.style.display = 'block';
            controlPanel.style.display = 'block';
            renderBtn.style.display = 'block';
            resultContainer.style.display = 'none';
            scale = 1; posX = 0; posY = 0; zoomSlider.value = 1;
            updateTransform();
        };
        reader.readAsDataURL(e.target.files[0]);
    });

    const getEventPos = (e) => ({
        x: e.touches ? e.touches[0].clientX : e.clientX,
        y: e.touches ? e.touches[0].clientY : e.clientY
    });

    const startMove = (e) => {
        isDragging = true;
        const pos = getEventPos(e);
        startX = pos.x - posX; startY = pos.y - posY;
    };

    const move = (e) => {
        if (!isDragging) return;
        const pos = getEventPos(e);
        posX = pos.x - startX; posY = pos.y - startY;
        updateTransform();
    };

    workArea.addEventListener('mousedown', startMove);
    window.addEventListener('mousemove', move);
    window.addEventListener('mouseup', () => isDragging = false);
    workArea.addEventListener('touchstart', startMove);
    window.addEventListener('touchmove', move);
    window.addEventListener('touchend', () => isDragging = false);

    zoomSlider.addEventListener('input', () => {
        scale = parseFloat(zoomSlider.value);
        updateTransform();
    });

    function updateTransform() {
        userImage.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
    }

    renderBtn.addEventListener('click', () => {
        const ctx = exportCanvas.getContext('2d');
        const frameImg = new Image();
        frameImg.src = 'AVATA-02.png';

        frameImg.onload = () => {
            ctx.clearRect(0, 0, 2000, 2000);
            const ratio = 2000 / workArea.offsetWidth;
            ctx.save();
            ctx.translate(posX * ratio, posY * ratio);
            ctx.scale(scale * ratio, scale * ratio);
            ctx.drawImage(userImage, 0, 0);
            ctx.restore();
            ctx.drawImage(frameImg, 0, 0, 2000, 2000);

            finalResult.src = exportCanvas.toDataURL("image/png");
            resultContainer.style.display = 'block';
            setTimeout(() => window.scrollTo({ top: document.body.scrollHeight, behavior: 'smooth' }), 100);
        };
    });
</script>
</body>
</html>
